---
title: wsæ¨¡å—å®ç°èŠå¤©çš„ä¸€äº›åŸºæœ¬åŠŸèƒ½
date: 2023-7-10
tags:
   - node
categories:
   - å‰ç«¯è¿›é˜¶
---



### *æœ¬ç¯‡æ–‡ç« éš¾åº¦è¾ƒå¤§å“¦ï¼Œå°ä¼™ä¼´ä»¬*ğŸ‘€ï¸

#### æœ¬æ–‡è¦è®²è§£çš„ä»£ç ä½œè€…å·²ä¸Šä¼ è‡³äº‘ä»“åº“ï¼š[https://gitee.com/xiao-zhe-is-not-lazy/chat](https://gitee.com/xiao-zhe-is-not-lazy/chat)

##### å­¦ä¹ æœ¬ç¯‡æ–‡ç« ä¹‹å‰è®°å¾—å…ˆå»çœ‹:

1.[ç™»å½•é‰´æƒâ€”â€”JWT(å‰åç«¯åˆ†ç¦») | Lazychild&#39;s Blog](https://www.lazychild.fun/2023/06/04/19/)
2. [åˆå§‹wsæ¨¡å— | Lazychild&#39;s Blog](https://www.lazychild.fun/2023/07/05/26/)

## å…ˆå†™å¥½ä¸€ä¸ªåŸºæœ¬çš„ç™»å½•é‰´æƒåŠŸèƒ½

ä¹‹å‰æ–‡ç« å†™è¿‡äº†ï¼Œå°ä¼™ä¼´ä»¬è‡ªå·±å»çœ‹çœ‹å§ğŸ‘€ï¸

å‰ç«¯ä¸€å…±æœ‰ä¸¤ä¸ªç•Œé¢ï¼š

* ç™»å½•ç•Œé¢
* èŠå¤©å®¤ç•Œé¢

åˆ°äº†è¿™ä¸€æ­¥åº”è¯¥å®ç°å‰ç«¯è¿›è¡Œç™»å½•ï¼Œåç«¯è¿›è¡Œtokenæ ¡éªŒï¼ŒæˆåŠŸåè·³è½¬è‡³èŠå¤©å®¤è¿™ä¸ªç•Œé¢ï¼ˆåªè¦è·³è½¬å°±è¡Œï¼Œåé¢ä¼šè®²èŠå¤©å®¤ç•Œé¢å¯¹äºtokençš„æ ¡éªŒï¼‰

## ä»£ç å±•ç¤º

* ç™»å½•ç•Œé¢ä»£ç 

```html
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç™»å½•</title>
    <script src="https://unpkg.com/axios@1.1.2/dist/axios.min.js"></script>
    <script>
        axios.interceptors.response.use(function (response) {
            // 2xx èŒƒå›´å†…çš„çŠ¶æ€ç éƒ½ä¼šè§¦å‘è¯¥å‡½æ•°ã€‚
            // å¯¹å“åº”æ•°æ®åšç‚¹ä»€ä¹ˆ
            const autorization = response.headers.autorization
            autorization && localStorage.setItem('token', autorization)
            return response
        }, function (error) {
            // è¶…å‡º 2xx èŒƒå›´çš„çŠ¶æ€ç éƒ½ä¼šè§¦å‘è¯¥å‡½æ•°ã€‚
            // å¯¹å“åº”é”™è¯¯åšç‚¹ä»€ä¹ˆ
            return Promise.reject(error);
        });
    </script>
</head>

<body>
    <h2>èŠå¤©å®¤ç™»å½•ç•Œé¢</h2>
    <div>è´¦å·ï¼š<input type="text" id="username"></div>
    <div>å¯†ç ï¼š<input type="text" id="password"></div>
    <button id="btn">ç™»å½•</button>
    <script>
        btn.onclick = function () {
            axios.post('http://localhost:3000/login', {
                username: username.value,
                password: password.value
            }).then(res => {
                if (res.data.ok) {
                    location.href = '/index'
                } else {
                    alert('è´¦å·æˆ–å¯†ç é”™è¯¯')
                }
            }).catch(err => {
                console.log(err)
            })
        }
    </script>
</body>

</html>
```

* åŸºæœ¬çš„è·¯ç”±ä»£ç 

```js
var express = require('express');
var jwtObj = require('../utils/jsonwebtoken')
const mysql2 = require('mysql2')
var router = express.Router();

/* GET home page. */
router.get('/login', function (req, res, next) {
    res.type('html');
    res.render('login')
})
router.get('/index', function (req, res, next) {
    res.type('html');
    res.render('index')
})

let mony, name
router.post('/login', async function (req, res) {
    a = 'users'
    // åˆ›å»ºè¿æ¥æ± 
    const config = handleConfig()
    const promisePool = mysql2.createPool(config).promise()
    let users = await promisePool.query(`SELECT * FROM ${a} WHERE name='${req.body.username}' AND password='${req.body.password}'`)  //sqlè¯­å¥
    if (users[0].length) {
        mony = users[0][0].mony
        name = users[0][0].name
          // å°†tokenæ”¾åœ¨headerä¸­
          const token = jwtObj.sign({ name, mony }, '1h')
          res.header('Autorization', token)
        res.send({
            ok: 1
        })
    } else {
        res.send({ ok: 0 })
    }
})
module.exports = router;


// è¿æ¥æ•°æ®åº“çš„åŸºæœ¬é…ç½®
function handleConfig() {
    return {
        host: 'localhost',
        port: 3306,
        user: "root",
        password: "",
        database: "maizuo",
        connectLimit: 1
    }
}
```

* tokenåŠ å¯†/è§£å¯†ä»£ç 

```js
const { json } = require('express')
const jwt = require('jsonwebtoken')
const key = 'maizuoc312asdpkj'  //ç§˜é’¥

const obj={
    // åŠ å¯†
    sign: function(data,time){
        const token=jwt.sign(data, key, { expiresIn: time })
        return token
    },
    verify: function(token){
        try {
            return jwt.verify(token, key)
        } catch (error) {
            return false            
        }
    }
}

module.exports=obj
```

<font color="red">å„ç§ä¾èµ–åŒ…è®°å¾—ä¸‹è½½</font>

* ä¾èµ–åŒ…å±•ç¤ºï¼ˆpackage.jsonæ–‡ä»¶ï¼‰

```json
{
  "name": "nodeapp2-jwt",
  "version": "0.0.0",
  "private": true,
  "scripts": {
    "start": "node ./bin/www"
  },
  "dependencies": {
    "cookie-parser": "~1.4.4",
    "debug": "~2.6.9",
    "ejs": "~2.6.1",
    "express": "~4.16.1",
    "http-errors": "~1.6.3",
    "jsonwebtoken": "^9.0.0",
    "morgan": "~1.9.1",
    "mysql2": "^3.3.3",
    "ws": "^8.13.0"
  }
}
```

## è¿›å…¥ä¸»é¢˜

wsæ¨¡å—å¤§å®¶ä¹‹å‰åº”è¯¥å°±ä½¿ç”¨è¿‡äº†å§ï¼Œè¿™é‡Œä¸»è¦æ˜¯ä¸ä¹‹å‰çš„ç™»å½•é‰´æƒå®ç°ä¸€äº›èŠå¤©çš„åŸºæœ¬åŠŸèƒ½ï¼Œæ¯”å¦‚ç¾¤èŠï¼Œå•èŠç­‰ï¼Œç«™é•¿è¿™é‡Œåªè®²åŠŸèƒ½ï¼Œé¡µé¢çš„ç¾åŒ–å¾—é å¤§å®¶ï¼Œ
**ç›´æ¥ä»£ç å±•ç¤º**
nodeæœåŠ¡ç«¯wsä»£ç å±•ç¤º(å»ºè®®æ–°å»ºä¸€ä¸ªæ–‡ä»¶ç‹¬ç«‹å†™wsçš„ä»£ç ï¼Œå®¹æ˜“ç»´æŠ¤)ï¼š

```js
const WebSocket = require("ws")
const { WebSocketServer } = require("ws")
const JWT = require('../utils/jsonwebtoken')

const wss = new WebSocketServer({ port: 8080 });

wss.on('connection', function connection(ws, req) {
  ws.on('error', console.error);
  //  éªŒè¯token
  const payload = JWT.verify(req.url.split('=')[1])
  if (payload) {
    ws.user = payload

    // é€šçŸ¥åœ¨çº¿ç”¨æˆ·çš„äººæ•°
    sendAll()
  } else {
    ws.send(createMessage(WebSocketType.Error, null, "ç™»å½•å·²è¿‡æœŸ"))
  }

  ws.on('message', function message(data, isBinary) {
    // è§£æå‰ç«¯å‘é€è¿‡æ¥çš„æ¶ˆæ¯è¿›è¡Œåˆ¤æ–­
    const msgObj = JSON.parse(data)
    // åˆ¤æ–­ï¼Œè¿›è¡Œé€»è¾‘å¤„ç†
    switch (msgObj.type) {
      case WebSocketType.groupList:
        break;
      case WebSocketType.groupChat:
        wss.clients.forEach(function each(client) {
          if (client !== ws && client.readyState === WebSocket.OPEN) {
            client.send(data, { binary: isBinary });
          }
        });
        break;
      case WebSocketType.singleChat:
        wss.clients.forEach(function each(client) {
          if (client.user.name == msgObj.to && client !== ws && client.readyState === WebSocket.OPEN) {
            client.send(data, { binary: isBinary });
          }
        });
        break;
    }
  })
  // å½“æœåŠ¡å™¨æ–­å¼€æ—¶è§¦å‘
  ws.on('close', () => {
    wss.clients.delete(ws.user)
    sendAll()
  })
});

const WebSocketType = {
  Error: 0,
  groupList: 1, //åœ¨çº¿äººæ•°
  groupChat: 2, //ç¾¤èŠ
  singleChat: 3 //å•èŠ
}

function createMessage(type, user, data) {
  return JSON.stringify({
    type,
    user,
    data
  })
}

// ç»™æ‰€æœ‰çš„åœ¨çº¿ç”¨æˆ·å®æ—¶å‘é€å½“å‰çš„ç”¨æˆ·åˆ—è¡¨
function sendAll() {
  wss.clients.forEach(function each(client) {
    if (client.readyState === WebSocket.OPEN) {
      client.send(createMessage(WebSocketType.groupList, null, JSON.stringify(Array.from(wss.clients).map(item => item.user))))
    }
  });
}
```

å‰ç«¯èŠå¤©å®¤ä»£ç å±•ç¤ºï¼š

```html
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èŠå¤©å®¤</title>
    <script src="https://unpkg.com/axios@1.1.2/dist/axios.min.js"></script>
</head>

<body>
    <h1>èŠå¤©å®¤</h1>
    <input type="text" class="message">
    <select name="" id="onlineUsers"></select>
    <button id="btn">å‘é€</button>
    <script>
        // toå­—æ®µä¸»è¦æ˜¯åœ¨å•èŠæ—¶ï¼ŒçŸ¥é“è¦å‘ç»™è°
        function createMessage(type, data, to) {
            return JSON.stringify({
                type,
                data,
                to
            })
        }
        let btn = document.querySelector('#btn')
        let message = document.querySelector('.message')
        let onlineUsers = document.querySelector('#onlineUsers')
        const WebSocketType = {
            Error: 0,
            groupList: 1, //åœ¨çº¿äººæ•°
            groupChat: 2, //ç¾¤èŠ
            singleChat: 3 //å•èŠ
        }
        const ws = new WebSocket(`ws://localhost:8080?token=${localStorage.getItem('token')}`)

        ws.onopen = () => {
            console.log("æœåŠ¡å™¨å·²è¿æ¥")
        }
        ws.onmessage = (msgObj) => {
            // è§£æåç«¯ä¼ è¿‡æ¥çš„å€¼ï¼Œè¿›è¡Œåˆ¤æ–­
            let dataObj = JSON.parse(msgObj.data)
            switch (dataObj.type) {
                case WebSocketType.Error:
                    location.href = '/login'
                    break;
                case WebSocketType.groupList:
                    // è·å–ç”¨æˆ·åˆ—è¡¨
                    onlineUsers.innerHTML ='<option value="all">ç¾¤å‘</option>' + JSON.parse(dataObj.data).map(item =>`<option value="${item.name}">${item.name}</option>`)
                    break;
                //ç¾¤èŠ 
                case WebSocketType.groupChat:
                    console.log('ç¾¤èŠ', dataObj)
                    break;
                //å•èŠ
                case WebSocketType.singleChat:
                    console.log('å•èŠ', dataObj)
                    break;
            }
            // å‘é€æ¶ˆæ¯
            btn.onclick = function () {
                if (onlineUsers.value == 'all') {
                    // ç¾¤å‘
                    ws.send(createMessage(WebSocketType.groupChat, message.value))
                }else{
                    // å•èŠ
                    ws.send(createMessage(WebSocketType.singleChat, message.value, onlineUsers.value))
                }
            }
        }
        ws.onerror = () => {
            console.log("error")
        }
    </script>
</body>

</html>
```

**èƒ½å¤Ÿçœ‹åˆ°è¿™é‡Œçš„å°ä¼™ä¼´ç»™è‡ªå·±é¼“é¼“æŒå§ï¼Œæœªæ¥çš„å‰ç«¯æ˜¯ä½ ä»¬çš„ğŸ‰ï¸**



